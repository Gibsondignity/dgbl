{% extends 'games/base.html' %}
{% comment %} {% block title %}Matching Game{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6 text-center">
  <form id="csrf-form">{% csrf_token %}</form>
  <h2 class="text-2xl font-bold text-blue-700 mb-4">üîó Match the Items</h2>
  {% if level_name %}
  <div class="mb-4">
    <span class="inline-block bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full font-medium">
      Level: {{ level_name }}
    </span>
  </div>
  {% endif %}
  <p class="text-gray-600 mb-4">Drag and match the items correctly. No pressure ‚Äî just fun!</p>

  <div id="game-container" class="grid grid-cols-2 gap-6 justify-center items-start mt-6">
    <div id="terms" class="space-y-4"></div>
    <div id="matches" class="space-y-4"></div>
  </div>

  <div class="mt-6">
    <button onclick="loadMatchingGame()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">üîÑ New Match</button>
  </div>

  <div id="success" class="hidden mt-6 text-green-600 text-xl font-bold animate-bounce">üéâ You matched everything!</div>
</div>

<script>
let currentData = [];

function loadMatchingGame() {
  const url = "{% url 'get_random_matching' %}" + (window.location.search || '');
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }
      currentData = data.items;
      loadMatchingGame();
    });
}

function shuffleGame() {
  document.getElementById('success').classList.add('hidden');
  // Remove any existing explanation div
  const existingExp = document.querySelector('.explanation-div');
  if (existingExp) existingExp.remove();

  const terms = [...currentData].sort(() => Math.random() - 0.5);
  const matches = [...currentData].sort(() => Math.random() - 0.5);

  document.getElementById('terms').innerHTML = terms.map((item, i) =>
    `<div class="bg-white shadow p-3 rounded draggable" draggable="true" data-term="${item.term}">${item.term}</div>`
  ).join('');

  document.getElementById('matches').innerHTML = matches.map((item, i) =>
    `<div class="bg-yellow-100 p-3 rounded drop-target" data-match="${item.match}">${item.match}</div>`
  ).join('');

  // Drag & Drop
  document.querySelectorAll('.draggable').forEach(el => {
    el.ondragstart = e => e.dataTransfer.setData("text", e.target.dataset.term);
  });

  document.querySelectorAll('.drop-target').forEach(el => {
    el.ondragover = e => e.preventDefault();
    el.ondrop = e => {
      const droppedTerm = e.dataTransfer.getData("text");
      if (currentData.find(d => d.term === droppedTerm && d.match === el.dataset.match)) {
        el.innerHTML = `‚úÖ ${droppedTerm}`;
        e.target.classList.add("bg-green-100");
        e.target.classList.remove("bg-yellow-100");
        e.target.ondrop = null;
        e.target.ondragover = null;
        checkWin();
      } else {
        alert("Oops! Try again.");
      }
    };
  });
}

function loadSpellingGame() {
    fetch("/games/api/get-random-spelling/")
      .then(res => res.json())
      .then(data => {
        currentWord = data.word;
        document.getElementById("spelling-input").value = "";
        document.getElementById("spelling-result").classList.add("hidden");
  
        document.getElementById("spelling-image").innerHTML = data.image
          ? `<img src="${data.image}" class="h-32 mx-auto" />`
          : "üî§";
  
        if (data.audio) {
          const audio = new Audio(data.audio);
          audio.play();
        }
      });
  }

  
function checkWin() {
  const total = document.querySelectorAll('.drop-target').length;
  const completed = document.querySelectorAll('.drop-target.bg-green-100').length;
  if (total === completed) {
    document.getElementById('success').classList.remove('hidden');
    // Show explanations
    showExplanations();
    // Trigger balloon celebration
    createBalloons();
    // Submit score
    submitGameScore('matching', total);
  }
}

function submitGameScore(gameType, score) {
  const levelId = new URLSearchParams(window.location.search).get('level');
  const formData = new FormData();
  formData.append('game_type', gameType);
  formData.append('score', score);
  formData.append('level_id', levelId || '');

  fetch("{% url 'submit_game' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log('Score submitted successfully');
      if (data.redirect) {
        window.location.href = data.redirect;
      }
    } else {
      console.error('Failed to submit score');
    }
  })
  .catch(err => console.error('Error submitting score:', err));
}

function createBalloons() {
  const container = document.body;
  for (let i = 0; i < 10; i++) {
    setTimeout(() => {
      const balloon = document.createElement('div');
      balloon.className = 'fixed text-4xl animate-bounce pointer-events-none z-50';
      balloon.innerHTML = 'üéà';
      balloon.style.left = Math.random() * 100 + '%';
      balloon.style.top = '100%';
      balloon.style.animationDuration = (Math.random() * 3 + 2) + 's';
      balloon.style.animationDelay = Math.random() * 0.5 + 's';
      container.appendChild(balloon);

      setTimeout(() => {
        balloon.remove();
      }, 4000);
    }, i * 200);
  }
}

function showExplanations() {
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'mt-6 bg-white p-4 rounded shadow explanation-div';
  explanationDiv.innerHTML = '<h3 class="text-xl font-bold mb-4">Explanations:</h3>';
  currentData.forEach(item => {
    explanationDiv.innerHTML += `
      <div class="mb-2">
        <strong>${item.term} ‚Üî ${item.match}</strong>
        <p class="text-gray-700">${item.explanation || 'No explanation available.'}</p>
      </div>
    `;
  });
  document.getElementById('game-container').appendChild(explanationDiv);
}

shuffleGame();
</script>
{% endblock %} {% endcomment %}


{% load static %}
{% block title %}Matching Game{% endblock %}

{% block content %}
<style>
  @keyframes floatUp {
      0% {
          transform: translateY(100vh) translateX(0);
          opacity: 0;
      }
      10% {
          opacity: 1;
      }
      100% {
          transform: translateY(-100px) translateX(calc(var(--offset) * 100px));
          opacity: 0;
      }
  }

  .floating-balloon {
      position: fixed;
      font-size: 2rem;
      z-index: 1000;
      pointer-events: none;
      animation: floatUp 3s ease-out forwards;
      left: calc(var(--start-x) * 1vw);
      top: 100vh;
  }

  @keyframes pop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  .pop-animation {
    animation: pop 0.5s ease;
  }
</style>

<div class="max-w-4xl mx-auto px-4 py-6 text-center">
  <form id="csrf-form">{% csrf_token %}</form>
  <h2 class="text-2xl font-bold text-blue-700 mb-4">üîó Match the Items</h2>
  {% if level_name %}
  <div class="mb-4">
    <span class="inline-block bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full font-medium">
      Level: {{ level_name }}
    </span>
  </div>
  {% endif %}
  <p class="text-gray-600 mb-4">Drag and match the items correctly. No pressure ‚Äî just fun!</p>

  <div id="game-container" class="grid grid-cols-2 gap-6 justify-center items-start mt-6">
    <div id="terms" class="space-y-4"></div>
    <div id="matches" class="space-y-4"></div>
  </div>

  <div class="mt-6">
    <button onclick="loadMatchingGame()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">üîÑ New Match</button>
  </div>

  <div id="success" class="hidden mt-6 text-green-600 text-xl font-bold pop-animation">üéâ You matched everything!</div>
</div>

<script>
    // üéµ Audio Setup
    const correctSound = new Audio("{% static 'sounds/correct.mp3' %}");
    const wrongSound = new Audio("{% static 'sounds/wronganswer.mp3' %}");

    // Fallback to WAV if MP3 fails
    correctSound.addEventListener('error', () => {
        console.warn("MP3 not supported, falling back to WAV for correct sound");
        correctSound.src = "{% static 'sounds/correct.wav' %}";
        correctSound.load();
    });

    wrongSound.addEventListener('error', () => {
        console.warn("MP3 not supported, falling back to WAV for wrong sound");
        wrongSound.src = "{% static 'sounds/wronganswer.wav' %}";
        wrongSound.load();
    });

    // üéµ Safe sound player
    function playSound(sound) {
        if (!sound) return;
        const clone = sound.cloneNode();
        clone.volume = 0.4;
        clone.play().catch(err => {
            console.warn("üîá Sound playback prevented:", err.message);
        });
    }

    // üéà Create floating balloons
    function createBalloons() {
        const container = document.body;
        if (!container) return;

        for (let i = 0; i < 8; i++) {
            setTimeout(() => {
                const balloon = document.createElement('div');
                balloon.className = 'floating-balloon';
                
                const emojis = ['üéà', 'üéâ', 'üéä', '‚≠ê', 'üèÜ', '‚úÖ', '‚ú®'];
                balloon.innerHTML = emojis[Math.floor(Math.random() * emojis.length)];

                const startX = Math.random() * 100;
                balloon.style.setProperty('--start-x', startX);

                const offset = (Math.random() - 0.5) * 4;
                balloon.style.setProperty('--offset', offset);

                const duration = 2 + Math.random() * 3;
                balloon.style.animationDuration = `${duration}s`;

                container.appendChild(balloon);

                setTimeout(() => {
                    if (balloon && balloon.parentNode) {
                        balloon.remove();
                    }
                }, duration * 1000 + 100);
            }, i * 150);
        }
    }

    // üéØ Game Logic
    let currentData = [];

    function loadMatchingGame() {
        const url = "{% url 'get_random_matching' %}" + (window.location.search || '');
        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                currentData = data.items;
                shuffleGame();
            })
            .catch(err => {
                console.error("Failed to load matching game:", err);
                document.getElementById("terms").innerHTML = `<p class="text-red-500">Failed to load game. Please try again.</p>`;
            });
    }

    function shuffleGame() {
        document.getElementById('success').classList.add('hidden');
        // Remove any existing explanation div
        const existingExp = document.querySelector('.explanation-div');
        if (existingExp) existingExp.remove();

        const terms = [...currentData].sort(() => Math.random() - 0.5);
        const matches = [...currentData].sort(() => Math.random() - 0.5);

        document.getElementById('terms').innerHTML = terms.map((item, i) =>
            `<div class="bg-white shadow p-3 rounded draggable cursor-move transform hover:scale-105 transition" draggable="true" data-term="${item.term}">
                ${item.image ? `<img src="${item.image}" class="h-10 inline mr-2 rounded">` : ""}
                ${item.term}
            </div>`
        ).join('');

        document.getElementById('matches').innerHTML = matches.map((item, i) =>
            `<div class="bg-yellow-100 p-3 rounded drop-target min-h-[48px] flex items-center justify-center border-2 border-dashed border-yellow-300 hover:border-yellow-400 transition">
                ${item.match}
            </div>`
        ).join('');

        // Drag & Drop
        document.querySelectorAll('.draggable').forEach(el => {
            el.ondragstart = e => {
                e.dataTransfer.setData("text", e.target.dataset.term);
                e.target.style.opacity = "0.5";
            };
            el.ondragend = e => {
                e.target.style.opacity = "1";
            };
        });

        document.querySelectorAll('.drop-target').forEach(el => {
            el.ondragover = e => {
                e.preventDefault();
                el.classList.add('border-blue-400', 'bg-blue-50');
            };
            el.ondragleave = e => {
                el.classList.remove('border-blue-400', 'bg-blue-50');
            };
            el.ondrop = e => {
                e.preventDefault();
                const droppedTerm = e.dataTransfer.getData("text");
                el.classList.remove('border-blue-400', 'bg-blue-50');

                const match = currentData.find(d => d.term === droppedTerm && d.match === el.dataset.match);
                if (match) {
                    playSound(correctSound);
                    el.innerHTML = `‚úÖ ${droppedTerm}`;
                    el.classList.add("bg-green-100", "border-green-300");
                    el.classList.remove("bg-yellow-100", "border-yellow-300", "border-dashed");
                    el.ondrop = null;
                    el.ondragover = null;
                    el.ondragleave = null;
                    checkWin();
                } else {
                    playSound(wrongSound);
                    alert("‚ùå Oops! Try again.");
                }
            };
        });
    }

    function checkWin() {
        const total = document.querySelectorAll('.drop-target').length;
        const completed = document.querySelectorAll('.drop-target.bg-green-100').length;
        if (total === completed) {
            playSound(correctSound);
            document.getElementById('success').classList.remove('hidden');
            showExplanations();
            createBalloons();
            submitGameScore('matching', total);
        }
    }

    // üìä Submit score without redirect
    function submitGameScore(gameType, score) {
        const levelId = new URLSearchParams(window.location.search).get('level');
        const formData = new FormData();
        formData.append('game_type', gameType);
        formData.append('score', score);
        formData.append('level_id', levelId || '');

        fetch("{% url 'submit_game' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                console.log('‚úÖ Score submitted successfully');
                // üö´ NO REDIRECT
            } else {
                console.error('‚ùå Failed to submit score');
            }
        })
        .catch(err => {
            console.error('‚ö†Ô∏è Error submitting score:', err);
        });
    }

    function showExplanations() {
        const explanationDiv = document.createElement('div');
        explanationDiv.className = 'mt-6 bg-white p-4 rounded shadow explanation-div border-l-4 border-green-500';
        explanationDiv.innerHTML = '<h3 class="text-xl font-bold mb-4">üåü Explanations:</h3>';
        currentData.forEach(item => {
            explanationDiv.innerHTML += `
                <div class="mb-4 p-3 bg-gray-50 rounded">
                    <div class="font-bold text-lg">${item.term} ‚Üî ${item.match}</div>
                    <p class="text-gray-700 mt-1">${item.explanation || 'No explanation available.'}</p>
                </div>
            `;
        });
        document.getElementById('game-container').insertAdjacentElement('afterend', explanationDiv);
    }

    // üöÄ Initialize
    document.addEventListener("DOMContentLoaded", () => {
        correctSound.load();
        wrongSound.load();
        loadMatchingGame();
    });
</script>
{% endblock %}