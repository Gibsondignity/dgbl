{% extends 'games/base.html' %}
{% block title %}Matching Game{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-6 text-center">
  <form id="csrf-form">{% csrf_token %}</form>
  <h2 class="text-2xl font-bold text-blue-700 mb-4">ðŸ”— Match the Items</h2>
  {% if level_name %}
  <div class="mb-4">
    <span class="inline-block bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full font-medium">
      Level: {{ level_name }}
    </span>
  </div>
  {% endif %}
  <p class="text-gray-600 mb-4">Drag and match the items correctly. No pressure â€” just fun!</p>

  <div id="game-container" class="grid grid-cols-2 gap-6 justify-center items-start mt-6">
    <div id="terms" class="space-y-4"></div>
    <div id="matches" class="space-y-4"></div>
  </div>

  <div class="mt-6">
    <button onclick="loadMatchingGame()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">ðŸ”„ New Match</button>
  </div>

  <div id="success" class="hidden mt-6 text-green-600 text-xl font-bold animate-bounce">ðŸŽ‰ You matched everything!</div>
</div>

<script>
let currentData = [];

function loadMatchingGame() {
  const url = "{% url 'get_random_matching' %}" + (window.location.search || '');
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert(data.error);
        return;
      }
      currentData = data.items;
      loadMatchingGame();
    });
}

function shuffleGame() {
  document.getElementById('success').classList.add('hidden');
  // Remove any existing explanation div
  const existingExp = document.querySelector('.explanation-div');
  if (existingExp) existingExp.remove();

  const terms = [...currentData].sort(() => Math.random() - 0.5);
  const matches = [...currentData].sort(() => Math.random() - 0.5);

  document.getElementById('terms').innerHTML = terms.map((item, i) =>
    `<div class="bg-white shadow p-3 rounded draggable" draggable="true" data-term="${item.term}">${item.term}</div>`
  ).join('');

  document.getElementById('matches').innerHTML = matches.map((item, i) =>
    `<div class="bg-yellow-100 p-3 rounded drop-target" data-match="${item.match}">${item.match}</div>`
  ).join('');

  // Drag & Drop
  document.querySelectorAll('.draggable').forEach(el => {
    el.ondragstart = e => e.dataTransfer.setData("text", e.target.dataset.term);
  });

  document.querySelectorAll('.drop-target').forEach(el => {
    el.ondragover = e => e.preventDefault();
    el.ondrop = e => {
      const droppedTerm = e.dataTransfer.getData("text");
      if (currentData.find(d => d.term === droppedTerm && d.match === el.dataset.match)) {
        el.innerHTML = `âœ… ${droppedTerm}`;
        e.target.classList.add("bg-green-100");
        e.target.classList.remove("bg-yellow-100");
        e.target.ondrop = null;
        e.target.ondragover = null;
        checkWin();
      } else {
        alert("Oops! Try again.");
      }
    };
  });
}

function loadSpellingGame() {
    fetch("/games/api/get-random-spelling/")
      .then(res => res.json())
      .then(data => {
        currentWord = data.word;
        document.getElementById("spelling-input").value = "";
        document.getElementById("spelling-result").classList.add("hidden");
  
        document.getElementById("spelling-image").innerHTML = data.image
          ? `<img src="${data.image}" class="h-32 mx-auto" />`
          : "ðŸ”¤";
  
        if (data.audio) {
          const audio = new Audio(data.audio);
          audio.play();
        }
      });
  }

  
function checkWin() {
  const total = document.querySelectorAll('.drop-target').length;
  const completed = document.querySelectorAll('.drop-target.bg-green-100').length;
  if (total === completed) {
    document.getElementById('success').classList.remove('hidden');
    // Show explanations
    showExplanations();
    // Trigger balloon celebration
    createBalloons();
    // Submit score
    submitGameScore('matching', total);
  }
}

function submitGameScore(gameType, score) {
  const levelId = new URLSearchParams(window.location.search).get('level');
  const formData = new FormData();
  formData.append('game_type', gameType);
  formData.append('score', score);
  formData.append('level_id', levelId || '');

  fetch("{% url 'submit_game' %}", {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      console.log('Score submitted successfully');
    } else {
      console.error('Failed to submit score');
    }
  })
  .catch(err => console.error('Error submitting score:', err));
}

function createBalloons() {
  const container = document.body;
  for (let i = 0; i < 10; i++) {
    setTimeout(() => {
      const balloon = document.createElement('div');
      balloon.className = 'fixed text-4xl animate-bounce pointer-events-none z-50';
      balloon.innerHTML = 'ðŸŽˆ';
      balloon.style.left = Math.random() * 100 + '%';
      balloon.style.top = '100%';
      balloon.style.animationDuration = (Math.random() * 3 + 2) + 's';
      balloon.style.animationDelay = Math.random() * 0.5 + 's';
      container.appendChild(balloon);

      setTimeout(() => {
        balloon.remove();
      }, 4000);
    }, i * 200);
  }
}

function showExplanations() {
  const explanationDiv = document.createElement('div');
  explanationDiv.className = 'mt-6 bg-white p-4 rounded shadow explanation-div';
  explanationDiv.innerHTML = '<h3 class="text-xl font-bold mb-4">Explanations:</h3>';
  currentData.forEach(item => {
    explanationDiv.innerHTML += `
      <div class="mb-2">
        <strong>${item.term} â†” ${item.match}</strong>
        <p class="text-gray-700">${item.explanation || 'No explanation available.'}</p>
      </div>
    `;
  });
  document.getElementById('game-container').appendChild(explanationDiv);
}

shuffleGame();
</script>
{% endblock %}
