{% extends 'games/base.html' %}
{% block title %}Spelling Game{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto px-4 py-6 text-center">
  <h2 class="text-2xl font-bold text-purple-700 mb-4">üìù Spelling Challenge</h2>
  {% if level_name %}
  <div class="mb-4">
    <span class="inline-block bg-purple-100 text-purple-800 text-sm px-3 py-1 rounded-full font-medium">
      Level: {{ level_name }}
    </span>
  </div>
  {% endif %}
  <p class="text-gray-600">Can you spell the word correctly?</p>

  <div class="mt-6" id="spelling-image"></div>

  <input type="text" id="spelling-input" class="mt-4 px-4 py-2 border border-gray-300 rounded w-full text-center text-lg" placeholder="Type your answer..." />
  
  <button onclick="checkSpelling()" class="bg-purple-500 text-white px-4 py-2 mt-4 rounded hover:bg-purple-600">
    ‚úÖ Check
  </button>

  <div class="mt-4">
    <button onclick="newSpelling()" class="text-sm text-blue-500 hover:underline">üîÅ New Word</button>
  </div>

  <div id="spelling-result" class="text-xl mt-6 font-bold hidden"></div>
</div>

<script>


    function loadMatchingGame() {
        fetch("/games/api/get-random-matching/")
          .then(res => res.json())
          .then(data => {
            if (data.error) return alert(data.error);
      
            const shuffledTerms = [...data.items].sort(() => Math.random() - 0.5);
            const shuffledMatches = [...data.items].sort(() => Math.random() - 0.5);
      
            document.getElementById('terms').innerHTML = shuffledTerms.map(i =>
              `<div class="draggable bg-white shadow p-3 rounded" draggable="true" data-term="${i.term}">
                ${i.image ? `<img src="${i.image}" class="h-10 inline mr-2">` : ""}${i.term}
              </div>`
            ).join('');
      
            document.getElementById('matches').innerHTML = shuffledMatches.map(i =>
              `<div class="drop-target bg-yellow-100 p-3 rounded" data-match="${i.match}">${i.match}</div>`
            ).join('');
      
            initMatchingDragDrop(data.items);
          });
      }

      
        let currentWord = null;

        function loadSpellingGame() {
          const url = "{% url 'get_random_spelling' %}" + (window.location.search || '');
          fetch(url)
            .then(res => res.json())
            .then(data => {
              if (data.error) {
                alert(data.error);
                return;
              }
              currentWord = data;
              document.getElementById("spelling-input").value = "";
              document.getElementById("spelling-result").classList.add("hidden");

              document.getElementById("spelling-image").innerHTML = data.image
                ? `<img src="${data.image}" class="h-32 mx-auto" />`
                : "üî§";

              if (data.audio) {
                const audio = new Audio(data.audio);
                audio.play();
              }
            });
        }

        function newSpelling() {
          loadSpellingGame();
        }

        function checkSpelling() {
        const input = document.getElementById('spelling-input').value.trim().toLowerCase();
        const result = document.getElementById('spelling-result');

        if (input === currentWord.word) {
            let html = "üéâ Correct!";
            if (currentWord.explanation) {
                html += `<br><span class="text-gray-700 text-sm">${currentWord.explanation}</span>`;
            }
            result.innerHTML = html;
            result.className = "text-green-600 text-xl mt-6 font-bold animate-bounce";
            // Trigger balloon celebration
            createBalloons();
        } else {
            let html = `‚ùå Try again! The correct spelling is: <strong>${currentWord.word}</strong>`;
            if (currentWord.explanation) {
                html += `<br><span class="text-gray-700 text-sm">${currentWord.explanation}</span>`;
            }
            result.innerHTML = html;
            result.className = "text-red-600 text-xl mt-6 font-bold";
        }
        result.classList.remove("hidden");
        }

        function createBalloons() {
          const container = document.body;
          for (let i = 0; i < 6; i++) {
            setTimeout(() => {
              const balloon = document.createElement('div');
              balloon.className = 'fixed text-4xl animate-bounce pointer-events-none z-50';
              balloon.innerHTML = 'üéà';
              balloon.style.left = Math.random() * 100 + '%';
              balloon.style.top = '100%';
              balloon.style.animationDuration = (Math.random() * 3 + 2) + 's';
              balloon.style.animationDelay = Math.random() * 0.5 + 's';
              container.appendChild(balloon);

              setTimeout(() => {
                balloon.remove();
              }, 4000);
            }, i * 150);
          }
        }

        loadSpellingGame();
</script>
{% endblock %}
